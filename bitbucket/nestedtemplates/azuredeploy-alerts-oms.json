{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "metadata": {
                "description": "The region where Azure will house the deployment."
            },
            "minLength": 5
        },
        "workspaceName": {
            "type": "string",
            "metadata": {
                "Description": "Name of Log Analytics workspace"
            }
        },
        "actionGroup": {
            "type": "string",
            "metadata": {
                "Description": "List of action groups for alert actions separated by semicolon"
            }
        }
    },
    "variables": {
        "namespace": "bitbucket",
        "nfsServerHeartBeatCheck": {
            "displayName": "BitBucket NFS Server Offline!",
            "query": "Heartbeat | where Computer == \"bbsnfs\"  | summarize m=max(TimeGenerated) | where m < ago(10m)",
            "category": "AlertIbiza",
            "name": "nfsServerHeartBeatCheck"
        },
        "nfsServerHeartBeatCheckAlert": {
            "displayName": "[concat('bb-AlertNFS-',uniqueString(resourceGroup().id))]",
            "name": "[toLower(concat('bb-AlertNFS-',uniqueString(resourceGroup().id)))]",
            "description": "BitBucket NFS Server Node Offline Alert - haven't received a heartbeat from the BitBucket NFS server for 10 minutes.",
            "severity": "critical",
            "thresholdOperator": "gt",
            "thresholdValue": 1,
            "schedule": {
                "name": "[toLower(concat('bb-ScheduleNFS-',uniqueString(resourceGroup().id, deployment().name)))]",
                "Interval": 5,
                "TimeSpan": 15
            },
            "azNsNotification": {
                "GroupIds": [
                    "[parameters('actionGroup')]"
                ],
                "CustomEmailSubject": "BitBucket NFS Server Offline!"
            }
        }
    },
    "resources": [
        {
            "name": "[concat(variables('namespace'), '-nfs-oms-solution-', uniqueString(resourceGroup().id))]",
            "location": "[parameters('location')]",
            "type": "Microsoft.OperationsManagement/solutions",
            "apiVersion": "2015-11-01-preview",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspacename'), variables('nfsServerHeartBeatCheck').name)]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules', parameters('workspacename'), variables('nfsServerHeartBeatCheck').name, variables('nfsServerHeartBeatCheckAlert').schedule.name)]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions', parameters('workspacename'), variables('nfsServerHeartBeatCheck').name, variables('nfsServerHeartBeatCheckAlert').schedule.name, variables('nfsServerHeartBeatCheckAlert').name)]"
            ],
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspacename'))]",
                "referencedResources": [],
                "containedResources": [
                    "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspacename'), variables('nfsServerHeartBeatCheck').name)]",
                    "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules', parameters('workspacename'), variables('nfsServerHeartBeatCheck').name, variables('nfsServerHeartBeatCheckAlert').schedule.name)]",
                    "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions', parameters('workspacename'), variables('nfsServerHeartBeatCheck').name, variables('nfsServerHeartBeatCheckAlert').schedule.name, variables('nfsServerHeartBeatCheckAlert').name)]"
                ]
            },
            "plan": {
                "name": "[concat(variables('namespace'), '[' ,parameters('workspaceName'), ']')]",
                "Version": "1.0.0.0'",
                "product": "BitBucket",
                "publisher": "Atlassian",
                "promotionCode": ""
            }
        },
        {
            "name": "[concat(parameters('workspacename'), '/', variables('nfsServerHeartBeatCheck').name)]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2017-03-15-preview",
            "dependsOn": [],
            "tags": {},
            "properties": {
                "etag": "*",
                "query": "[variables('nfsServerHeartBeatCheck').query]",
                "displayname": "[variables('nfsServerHeartBeatCheck').displayName]",
                "category": "[variables('nfsServerHeartBeatCheck').category]"
            }
        },
        {
            "name": "[concat(parameters('workspaceName'), '/', variables('nfsServerHeartBeatCheck').name, '/', variables('nfsServerHeartBeatCheckAlert').schedule.name)]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules/",
            "apiVersion": "2017-03-15-preview",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'), '/savedSearches/', variables('nfsServerHeartBeatCheck').name)]"
            ],
            "properties": {
                "etag": "*",
                "interval": "[variables('nfsServerHeartBeatCheckAlert').schedule.Interval]",
                "queryTimeSpan": "[variables('nfsServerHeartBeatCheckAlert').schedule.TimeSpan]",
                "enabled": true
            }
        },
        {
            "name": "[concat(parameters('workspaceName'), '/', variables('nfsServerHeartBeatCheck').name, '/', variables('nfsServerHeartBeatCheckAlert').schedule.name, '/', variables('nfsServerHeartBeatCheckAlert').name)]",
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches/schedules/actions",
            "apiVersion": "2017-03-15-preview",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'), '/savedSearches/', variables('nfsServerHeartBeatCheck').name, '/schedules/', variables('nfsServerHeartBeatCheckAlert').schedule.name)]"
            ],
            "properties": {
                "etag": "*",
                "Type": "Alert",
                "Name": "[variables('nfsServerHeartBeatCheckAlert').displayName]",
                "Description": "[variables('nfsServerHeartBeatCheckAlert').description]",
                "Severity": "[variables('nfsServerHeartBeatCheckAlert').severity]",
                "Threshold": {
                    "Operator": "[variables('nfsServerHeartBeatCheckAlert').thresholdOperator]",
                    "Value": "[variables('nfsServerHeartBeatCheckAlert').thresholdValue]"
                },
                "AzNsNotification": {
                    "GroupIds": "[variables('nfsServerHeartBeatCheckAlert').azNsNotification.GroupIds]",
                    "CustomEmailSubject": "[variables('nfsServerHeartBeatCheckAlert').azNsNotification.CustomEmailSubject]"
                }
            }
        }
    ]
}