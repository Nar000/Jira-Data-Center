{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "scriptsBranch": {
            "type": "string",
            "defaultValue": "master",
            "metadata": {
                "description": "A branch in the repository to download scripts from. We want to be able to override it during development."
            }
        },
        "repositoryLocation": {
            "type": "string",
            "metadata": {
                "description": "The base URI where the source of the template are located"
            },
            "defaultValue": "[concat('https://bitbucket.org/atlassian/atlassian-azure-deployment/raw/', parameters('scriptsBranch'), '/')]"
        },
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located"
            },
            "defaultValue": "[parameters('repositoryLocation')]"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated. Use the defaultValue if the staging location is not secured."
            },
            "defaultValue": ""
        },
        "bitbucketVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "The Bitbucket software product version to install. You can also specify 'latest' to download the latest version available. If using with customDownloadUrl you have to specify the correct version."
            }
        },
        "customDownloadUrl": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Use this URL to override standard Atlassian download url eg for EAP, RC versions. NB will be used in conjunction with the bitbucketVersion parameter."
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Azure region (WestUS, CentralUs, AustraliaEast, etc) shared by all of the resources in the template"
            }
        },
        "vnetCIDR": {
            "type": "string",
            "defaultValue": "10.0.0.0/16",
            "metadata": {
                "description": "Address space for the Virtual Network created by the template"
            }
        },
        "publicNetCIDR": {
            "type": "string",
            "defaultValue": "10.0.1.0/24",
            "metadata": {
                "description": "Address space for the public subnet in the vnet"
            }
        },
        "appgwNetCIDR": {
            "type": "string",
            "defaultValue": "10.0.2.0/24",
            "metadata": {
                "description": "Address space for the private subnet with Application Gateways"
            }
        },
        "bbsNetCIDR": {
            "type": "string",
            "defaultValue": "10.0.4.0/24",
            "metadata": {
                "description": "Address space for the private subnet where Bitbucket Server nodes are deployed"
            }
        },
        "esNetCIDR": {
            "type": "string",
            "defaultValue": "10.0.5.0/24",
            "metadata": {
                "description": "Address space for the private subnet where Elasticsearch nodes are deployed"
            }
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Username for SSH access to Bitbucket Server nodes as well as for the jumpbox"
            }
        },
        "sshKey": {
            "type": "string",
            "metadata": {
                "description": "SSH key to allow access to jumpbox."
            }
        },
        "jumpboxSize": {
            "type": "string",
            "defaultValue": "Standard_B1s",
            "metadata": {
                "description": "The size of jumpbox VM"
            }
        },
        "jumpboxHostname": {
            "type": "string",
            "defaultValue": "jumpbox",
            "metadata": {
                "description": "The hostname for jumpbox. Does not affect it's DNS name"
            }
        },
        "bbsSize": {
            "type": "string",
            "defaultValue": "Standard_DS3_v2",
            "allowedValues": [
                "Standard_DS3_v2",
                "Standard_D8s_v3",
                "Standard_DS4_v2",
                "Standard_E2s_v3",
                "Standard_E4-2s_v3",
                "Standard_E8-4s_v3"
            ],
            "metadata": {
                "description": "The size of Bitbucket Server nodes vm"
            }
        },
        "bbsNodeCount": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "The amount of Bitbucket Server nodes to deploy"
            }
        },
        "bbsNodePrefix": {
            "type": "string",
            "defaultValue": "bbsnode",
            "metadata": {
                "description": "Hostname prefix for nodes in Bitbucket Server cluster"
            }
        },
        "bbsDiskSize": {
            "type": "int",
            "defaultValue": 31,
            "metadata": {
                "description": "The size (in GB) of the data disk that is used for logs on a Bitbucket Server node"
            }
        },
        "bbsDiskStorageType": {
            "type": "string",
            "defaultValue": "Standard_LRS",
            "metadata": {
                "description": "The type of storage account used for logs on a Bitbucket Server node"
            }
        },
        "bbsHttpPort": {
            "type": "string",
            "defaultValue": "7990",
            "metadata": {
                "description": "Internal port that Bitbucket Server uses to accept HTTP connections"
            }
        },
        "bbsHazelcastTag": {
            "type": "string",
            "defaultValue": "HAZELCAST",
            "metadata": {
                "description": "Hazelcast tag for nodes in Bitbucket Server cluster"
            }
        },
        "bbsHazelcastPort": {
            "type": "string",
            "defaultValue": "5701",
            "metadata": {
                "description": "Internal port that Bitbucket Server uses for Hazelcast communication"
            }
        },
        "azureSqlTier": {
            "type": "string",
            "defaultValue": "P2",
            "allowedValues": [
                "Basic",
                "S0",
                "S1",
                "S2",
                "S3",
                "S4",
                "S6",
                "S7",
                "S9",
                "S12",
                "P1",
                "P2",
                "P4",
                "P6",
                "P11",
                "P15"
            ],
            "metadata": {
                "description": "Database Tier for Azure SQL DTU pricing model"
            }
        },
        "azureSqlUsername": {
            "type": "string",
            "metadata": {
                "description": "Username to access Bitbucket Server database."
            }
        },
        "azureSqlPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password to access Bitbucket Server database."
            }
        },
        "nfsVmSize": {
            "type": "string",
            "defaultValue": "Standard_DS3_v2",
            "allowedValues": [
                "Standard_DS3_v2",
                "Standard_D8s_v3",
                "Standard_DS4_v2",
                "Standard_E8-4s_v3",
                "Standard_L4s",
                "Standard_L8s",
                "Standard_L16s",
                "Standard_L32s",
                "Standard_D16_v3",
                "Standard_E16s_v3"
            ],
            "metadata": {
                "description": "The size of the VM that is used for NFS server."
            }
        },
        "nfsDiskSize": {
            "type": "int",
            "defaultValue": 128,
            "allowedValues": [
                128,
                256,
                512,
                1024,
                2048,
                4095
            ],
            "metadata": {
                "description": "The size of the data disk for Git repositories in GB"
            }
        },
        "appGatewaySize": {
            "type": "string",
            "defaultValue": "Medium",
            "allowedValues": [
                "Small",
                "Medium",
                "Large"
            ],
            "metadata": {
                "description": "The size of Application Gateway. Can be small, medium and large."
            }
        },
        "appGatewayProbeInterval": {
            "type": "int",
            "defaultValue": 5,
            "metadata": {
                "description": "The interval in seconds for Application Gateway to very that Bitbucket Server node is available"
            }
        },
        "appGatewayCapacity": {
            "type": "int",
            "defaultValue": 1,
            "metadata": {
                "description": "Amount of Application Gateway instances to created"
            }
        },
        "httpGatewaySize": {
            "type": "string",
            "allowedValues": [
                "Standard_D2s_v3",
                "Standard_D4s_v3",
                "Standard_D8s_v3",
                "Standard_D16s_v3",
                "Standard_D32s_v3",
                "Standard_D64s_v3"
            ],
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "VM type which used for forwarding HTTP traffic from Load Balancer to Application Gateway"
            }
        },
        "license": {
            "type": "securestring",
            "defaultValue": "AAABpg0ODAoPeNp1kUtP20AUhff+FVfqLtI4DkkgRLLUYA+UqtiR7SzawmLiXPBQe8aaR9r013ewDYG2LGZzH2fO+e6HorKQyD0ECwhmy/lsOZ3D1U0BJ8Fk4SW22aJK7zcalQ7JxIukMKw0CWswfDSVbJj+yEzNtOZM+KVsPG2YrvwvvEShsTi02M3mxSoraPZv96WztqqsmMaYGQyfPieTCQkW3ntKQ53+ark6dEvr6fT007NDesN4/Y7FHNUe1XUcXtAzSmbxtxNymn4+I1fT88Xg0AmyCIVBFRpl0cvtVpeKt4ZL0VdGo1GSFuQyzcg6S+NNVFynCdnk1DXCSKFztIPtAUyFMHgFKkq5QwWtko9YGvheGdPeLsfjB+m/sTiu+w2C/cadD7EEIQ3suDaKb61Bp8w1GAml1UY27kC+50I7z4KJ8jUYR/N8oNmnc3z4Hl9yRBldFTQmF1+fvP+f2RDBQduIH0L+FF5Ok9A9Mg8CL1UPTHDNOjyr31YhxNjW8tA4hl5Hw3X+Pm2MR6Z0z2rbTcGQHe6lgl5rd9Q6zvX2/wDFKfAUMCsCFH8cSCeQYWgwBdkxpTeUqGiTfg2qAhNxOHcjUrs7UMuuXFQw4T4+mxFqX02k8",
            "metadata": {
                "description": "Bitbucket Data Center 14 days evaluation license."
            }
        },
        "bitbucketAdminUsername": {
            "type": "string",
            "defaultValue": "ssh",
            "metadata": {
                "description": "Username for Bitbucket Server administrator user. By default it's the same as ssh user."
            }
        },
        "bitbucketAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for Bitbucket Server administrator user."
            }
        },
        "bitbucketAdminName": {
            "type": "string",
            "defaultValue": "John Doe",
            "metadata": {
                "description": "Bitbucket Server administorator full name."
            }
        },
        "bitbucketAdminEmail": {
            "type": "string",
            "defaultValue": "admin@example.com",
            "metadata": {
                "description": "Bitbucket Server administrator email."
            }
        },
        "esDataNodeCount": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "The number of elasticsearch data nodes to be deployed."
            }
        },
        "esDataDiskSize": {
            "type": "int",
            "defaultValue": 32,
            "metadata": {
                "description": "The size of the data disk for elasticsearch in GB."
            }
        },
        "esNodeSize": {
            "type": "string",
            "defaultValue": "Standard_DS3_v2",
            "allowedValues": [
                "Standard_DS3_v2",
                "Standard_D8s_v3",
                "Standard_DS4_v2",
                "Standard_E2s_v3",
                "Standard_E4-2s_v3",
                "Standard_E8-4s_v3"
            ],
            "metadata": {
                "description": "The size of Elasticsearch nodes VM."
            }
        }
    },
    "variables": {
        "vpcTemplateUri": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azuredeploy-vpc.json', parameters('_artifactsLocationSasToken')))]",
        "bitbucketTemplateUri": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/azuredeploy-bitbucket.json', parameters('_artifactsLocationSasToken')))]"
    },
    "resources": [
        {
            "apiVersion": "2018-05-01",
            "name": "pid-49ff88fd-5e3c-58f7-aadf-6a73ac08ea91",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "vpcTemplate",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vpcTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "appGatewayCapacity": {
                        "value": "[parameters('appGatewayCapacity')]"
                    },
                    "appGatewayProbeInterval": {
                        "value": "[parameters('appGatewayProbeInterval')]"
                    },
                    "appGatewaySize": {
                        "value": "[parameters('appGatewaySize')]"
                    },
                    "appgwNetCIDR": {
                        "value": "[parameters('appgwNetCIDR')]"
                    },
                    "bbsHazelcastPort": {
                        "value": "[parameters('bbsHazelcastPort')]"
                    },
                    "bbsHttpPort": {
                        "value": "[parameters('bbsHttpPort')]"
                    },
                    "bbsNetCIDR": {
                        "value": "[parameters('bbsNetCIDR')]"
                    },
                    "jumpboxHostname": {
                        "value": "[parameters('jumpboxHostname')]"
                    },
                    "jumpboxSize": {
                        "value": "[parameters('jumpboxSize')]"
                    },
                    "nfsVmSize": {
                        "value": "[parameters('nfsVmSize')]"
                    },
                    "publicNetCIDR": {
                        "value": "[parameters('publicNetCIDR')]"
                    },
                    "sshKey": {
                        "value": "[parameters('sshKey')]"
                    },
                    "vnetCIDR": {
                        "value": "[parameters('vnetCIDR')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "bitbucketTemplate",
            "dependsOn": [
                "vpcTemplate"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('bitbucketTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "appGatewayCapacity": {
                        "value": "[parameters('appGatewayCapacity')]"
                    },
                    "appGatewayProbeInterval": {
                        "value": "[parameters('appGatewayProbeInterval')]"
                    },
                    "appGatewaySize": {
                        "value": "[parameters('appGatewaySize')]"
                    },
                    "appgwNetCIDR": {
                        "value": "[parameters('appgwNetCIDR')]"
                    },
                    "azureSqlPassword": {
                        "value": "[parameters('azureSqlPassword')]"
                    },
                    "azureSqlTier": {
                        "value": "[parameters('azureSqlTier')]"
                    },
                    "azureSqlUsername": {
                        "value": "[parameters('azureSqlUsername')]"
                    },
                    "bbsDiskSize": {
                        "value": "[parameters('bbsDiskSize')]"
                    },
                    "bbsDiskStorageType": {
                        "value": "[parameters('bbsDiskStorageType')]"
                    },
                    "bbsHazelcastPort": {
                        "value": "[parameters('bbsHazelcastPort')]"
                    },
                    "bbsHazelcastTag": {
                        "value": "[parameters('bbsHazelcastTag')]"
                    },
                    "bbsHttpPort": {
                        "value": "[parameters('bbsHttpPort')]"
                    },
                    "bbsNetCIDR": {
                        "value": "[parameters('bbsNetCIDR')]"
                    },
                    "bbsNodeCount": {
                        "value": "[parameters('bbsNodeCount')]"
                    },
                    "bbsNodePrefix": {
                        "value": "[parameters('bbsNodePrefix')]"
                    },
                    "bbsSize": {
                        "value": "[parameters('bbsSize')]"
                    },
                    "bitbucketAdminEmail": {
                        "value": "[parameters('bitbucketAdminEmail')]"
                    },
                    "bitbucketAdminName": {
                        "value": "[parameters('bitbucketAdminName')]"
                    },
                    "bitbucketAdminPassword": {
                        "value": "[parameters('bitbucketAdminPassword')]"
                    },
                    "bitbucketAdminUsername": {
                        "value": "[parameters('bitbucketAdminUsername')]"
                    },
                    "bitbucketVersion": {
                        "value": "[parameters('bitbucketVersion')]"
                    },
                    "customDownloadUrl": {
                        "value": "[parameters('customDownloadUrl')]"
                    },
                    "esDataDiskSize": {
                        "value": "[parameters('esDataDiskSize')]"
                    },
                    "esDataNodeCount": {
                        "value": "[parameters('esDataNodeCount')]"
                    },
                    "esNetCIDR": {
                        "value": "[parameters('esNetCIDR')]"
                    },
                    "esNodeSize": {
                        "value": "[parameters('esNodeSize')]"
                    },
                    "httpGatewaySize": {
                        "value": "[parameters('httpGatewaySize')]"
                    },
                    "jumpboxHostname": {
                        "value": "[parameters('jumpboxHostname')]"
                    },
                    "jumpboxSize": {
                        "value": "[parameters('jumpboxSize')]"
                    },
                    "license": {
                        "value": "[parameters('license')]"
                    },
                    "nfsDiskSize": {
                        "value": "[parameters('nfsDiskSize')]"
                    },
                    "nfsVmSize": {
                        "value": "[parameters('nfsVmSize')]"
                    },
                    "publicNetCIDR": {
                        "value": "[parameters('publicNetCIDR')]"
                    },
                    "repositoryLocation": {
                        "value": "[parameters('repositoryLocation')]"
                    },
                    "scriptsBranch": {
                        "value": "[parameters('scriptsBranch')]"
                    },
                    "sshKey": {
                        "value": "[parameters('sshKey')]"
                    },
                    "vnetCIDR": {
                        "value": "[parameters('vnetCIDR')]"
                    },
                    "jumpboxPrivateIpAddress": {
                        "value": "[reference('vpcTemplate').outputs.jumpboxPrivateIpAddress.value]"
                    },
                    "nfsPrivateIpAddress": {
                        "value": "[reference('vpcTemplate').outputs.nfsPrivateIpAddress.value]"
                    },
                    "appGatewayFqdn": {
                        "value": "[reference('vpcTemplate').outputs.appGatewayFqdn.value]"
                    },
                    "lbFqdn": {
                        "value": "[reference('vpcTemplate').outputs.lbFqdn.value]"
                    }

                }
            }
        }
    ],
    "outputs": {
        "ssh": {
            "type": "string",
            "value": "[concat('ssh ', parameters('adminUsername'), '@', reference('vpcTemplate').outputs.ssh.value)]"
        },
        "appGatewayFqdn": {
            "type": "string",
            "value": "[reference('vpcTemplate').outputs.appGatewayFqdn.value]"
        },
        "jumpbox": {
            "type": "string",
            "value": "[reference('vpcTemplate').outputs.lbFqdn.value]"
        },
        "nfs": {
            "type": "string",
            "value": "[reference('bitbucketTemplate').outputs.nfs.value]"
        },
        "cmd": {
            "type": "string",
            "value": "[reference('bitbucketTemplate').outputs.cmd.value]"
        }
    }
}